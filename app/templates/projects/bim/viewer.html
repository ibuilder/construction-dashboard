{% extends 'layout.html' %}

{% block title %}
    {{ model.name }} - {{ project.name }} - BIM Viewer
{% endblock %}

{% block styles %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bim-viewer.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Viewer Header -->
        <div class="col-12 mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3>{{ model.name }}</h3>
                    <p class="text-muted mb-0">{{ model.model_type|title }} Model | Version: {{ version.version_number }}</p>
                </div>
                <div>
                    <div class="btn-group">
                        <a href="{{ url_for('projects.bim.models', project_id=project.id) }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Models
                        </a>
                        <a href="{{ url_for('projects.bim.model_versions', project_id=project.id, model_id=model.id) }}" class="btn btn-outline-primary">
                            <i class="bi bi-layers"></i> Versions
                        </a>
                        <a href="{{ url_for('projects.bim.issues', project_id=project.id, model_id=model.id) }}" class="btn btn-outline-warning">
                            <i class="bi bi-exclamation-triangle"></i> Issues
                        </a>
                        <a href="{{ url_for('projects.bim.download_model', project_id=project.id, version_id=version.id) }}" class="btn btn-outline-info">
                            <i class="bi bi-download"></i> Download
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">BIM Viewer</h6>
                    <div class="dropdown no-arrow">
                        <a class="dropdown-toggle" href="#" role="button" id="viewerDropdown" 
                           data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="bi bi-three-dots-vertical"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end shadow animated--fade-in" 
                             aria-labelledby="viewerDropdown">
                            <a class="dropdown-item" href="#" id="fullScreen">
                                <i class="bi bi-fullscreen"></i> Full Screen
                            </a>
                            <a class="dropdown-item" href="#" id="toggleWireframe">
                                <i class="bi bi-grid-3x3"></i> Toggle Wireframe
                            </a>
                            <a class="dropdown-item" href="#" id="toggleShadows">
                                <i class="bi bi-brightness-high"></i> Toggle Shadows
                            </a>
                            <a class="dropdown-item" href="#" id="resetView">
                                <i class="bi bi-arrow-repeat"></i> Reset View
                            </a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#" id="saveViewpoint">
                                <i class="bi bi-bookmark"></i> Save Current View
                            </a>
                            <a class="dropdown-item" href="#" id="viewSavedViews">
                                <i class="bi bi-bookmarks"></i> Saved Views
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="bim-viewer-container">
                        <!-- BIM Viewer will be loaded here -->
                        <div id="bim-viewer" class="bim-viewer"></div>
                        
                        <!-- Loading indicator -->
                        <div id="loading-indicator" class="loading-container">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading Model...</p>
                        </div>
                        
                        <!-- Error message -->
                        <div id="error-message" class="error-message" style="display: none;">
                            <div class="alert alert-danger" role="alert">
                                <h4 class="alert-heading">Error Loading Model</h4>
                                <p id="error-message-text">Unable to load the BIM model. Please try again later.</p>
                                <hr>
                                <p class="mb-0">If the problem persists, please contact support.</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-between">
                    <div class="viewer-controls">
                        <div class="btn-group mr-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="zoomIn">
                                <i class="bi bi-zoom-in"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="zoomOut">
                                <i class="bi bi-zoom-out"></i>
                            </button>
                        </div>
                        <div class="btn-group mr-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="rotateLeft">
                                <i class="bi bi-arrow-counterclockwise"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="rotateRight">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleOrbit">
                                <i class="bi bi-globe"></i> Orbit
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleFirstPerson">
                                <i class="bi bi-person"></i> First Person
                            </button>
                        </div>
                    </div>
                    <div class="info-panel">
                        <small class="text-muted">
                            Model ID: {{ model.id }} | 
                            Version: {{ version.version_number }} | 
                            Last Updated: {{ version.created_at.strftime('%Y-%m-%d') }}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Element Info Panel -->
    <div class="row">
        <div class="col-lg-12">
            <div class="card shadow mb-4" id="element-info-panel" style="display: none;">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Element Information</h6>
                    <button type="button" class="btn-close" aria-label="Close" id="closeElementInfo"></button>
                </div>
                <div class="card-body">
                    <div id="element-properties">
                        <p class="text-center text-muted">Select an element in the model to view its properties.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Saved Views Modal -->
    <div class="modal fade" id="savedViewsModal" tabindex="-1" aria-labelledby="savedViewsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="savedViewsModalLabel">Saved Views</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row" id="savedViewsList">
                        <p class="text-center text-muted">No saved views found.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Save View Modal -->
    <div class="modal fade" id="saveViewModal" tabindex="-1" aria-labelledby="saveViewModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="saveViewModalLabel">Save Current View</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="saveViewForm">
                        <div class="mb-3">
                            <label for="viewName" class="form-label">View Name</label>
                            <input type="text" class="form-control" id="viewName" required>
                        </div>
                        <div class="mb-3">
                            <label for="viewDescription" class="form-label">Description (Optional)</label>
                            <textarea class="form-control" id="viewDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveViewConfirm">Save View</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <!-- Three.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- OrbitControls for camera manipulation -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <!-- IFC.js for BIM model loading -->
    <script src="https://unpkg.com/web-ifc@0.0.36/web-ifc-api.js"></script>
    <script src="https://unpkg.com/three-mesh-bvh@0.5.15/build/three-mesh-bvh.js"></script>
    <script src="https://unpkg.com/web-ifc-three@0.0.122/IFCLoader.js"></script>
    
    <script>
        // Global variables
        let scene, camera, renderer, controls;
        let ifcLoader, model;
        let wireframeMode = false;
        let shadowsEnabled = true;
        let currentViewpoint = null;
        let savedViews = [];
        
        // Model information from the server
        const modelData = {
            id: "{{ model.id }}",
            name: "{{ model.name }}",
            type: "{{ model.model_type }}",
            version: "{{ version.version_number }}",
            url: "{{ url_for('projects.bim.get_model_file', project_id=project.id, version_id=version.id) }}"
        };
        
        // Initialize the viewer when the page is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initViewer();
            setupEventListeners();
            loadModel();
        });
        
        // Initialize the 3D viewer
        function initViewer() {
            // Create scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);
            
            // Add ambient light
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            
            // Add directional light
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(5, 10, 7.5);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
            
            // Initialize camera
            const container = document.getElementById('bim-viewer');
            const aspect = container.clientWidth / container.clientHeight;
            camera = new THREE.PerspectiveCamera(45, aspect, 0.1, 1000);
            camera.position.set(10, 10, 10);
            
            // Initialize renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);
            
            // Initialize orbit controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.screenSpacePanning = true;
            
            // Initialize IFC loader
            ifcLoader = new IFCLoader();
            ifcLoader.ifcManager.setWasmPath('https://unpkg.com/web-ifc@0.0.36/');
            
            // Add a grid helper
            const gridHelper = new THREE.GridHelper(50, 50);
            scene.add(gridHelper);
            
            // Handle window resize
            window.addEventListener('resize', onWindowResize);
            
            // Start animation loop
            animate();
        }
        
        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        
        // Handle window resize
        function onWindowResize() {
            const container = document.getElementById('bim-viewer');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }
        
        // Load the BIM model
        function loadModel() {
            // Show loading indicator
            document.getElementById('loading-indicator').style.display = 'flex';
            document.getElementById('error-message').style.display = 'none';
            
            // Load the model using IFC.js
            ifcLoader.load(
                modelData.url,
                (ifcModel) => {
                    // Add the model to the scene
                    model = ifcModel;
                    scene.add(model);
                    
                    // Setup element selection
                    setupModelSelection(model);
                    
                    // Hide loading indicator
                    document.getElementById('loading-indicator').style.display = 'none';
                    
                    // Center camera on model
                    centerCameraOnModel(model);
                },
                (progress) => {
                    // Handle loading progress
                    const percentComplete = Math.round((progress.loaded / progress.total) * 100);
                    document.querySelector('#loading-indicator p').textContent = 
                        `Loading Model... ${percentComplete}%`;
                },
                (error) => {
                    // Handle loading error
                    console.error('Error loading IFC model:', error);
                    document.getElementById('loading-indicator').style.display = 'none';
                    document.getElementById('error-message').style.display = 'block';
                    document.getElementById('error-message-text').textContent = 
                        'Failed to load the BIM model: ' + error.message;
                }
            );
        }
        
        // Setup element selection
        function setupModelSelection(model) {
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();
            
            // Add event listener for element selection
            renderer.domElement.addEventListener('click', (event) => {
                // Calculate mouse position
                const rect = renderer.domElement.getBoundingClientRect();
                mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                
                // Cast ray
                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObject(model, true);
                
                if (intersects.length > 0) {
                    // Get element information
                    const elementId = intersects[0].object.userData.id;
                    if (elementId) {
                        getElementProperties(elementId);
                    }
                }
            });
        }
        
        // Get element properties
        function getElementProperties(elementId) {
            // This would typically be an AJAX request to get element properties
            // For demonstration, we'll create some sample data
            const sampleProperties = {
                id: elementId,
                name: 'Sample Element ' + elementId,
                type: 'Wall',
                material: 'Concrete',
                width: '200mm',
                height: '3000mm',
                length: '5000mm',
                volume: '3.0m³',
                level: 'Level 1'
            };
            
            displayElementProperties(sampleProperties);
        }
        
        // Display element properties
        function displayElementProperties(properties) {
            const panel = document.getElementById('element-info-panel');
            const content = document.getElementById('element-properties');
            
            // Create HTML content
            let html = '<table class="table table-striped">';
            html += '<thead><tr><th>Property</th><th>Value</th></tr></thead>';
            html += '<tbody>';
            
            for (const [key, value] of Object.entries(properties)) {
                html += `<tr><td>${key.charAt(0).toUpperCase() + key.slice(1)}</td><td>${value}</td></tr>`;
            }
            
            html += '</tbody></table>';
            
            // Update content and show panel
            content.innerHTML = html;
            panel.style.display = 'block';
        }
        
        // Center camera on model
        function centerCameraOnModel(model) {
            // Compute bounding box
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            
            // Set camera position
            const maxDim = Math.max(size.x, size.y, size.z);
            const fov = camera.fov * (Math.PI / 180);
            let cameraZ = Math.abs(maxDim / Math.sin(fov / 2));
            
            // Set orbit controls target
            controls.target = center;
            camera.position.set(center.x + cameraZ * 0.5, center.y + cameraZ * 0.5, center.z + cameraZ * 0.5);
            camera.updateProjectionMatrix();
            controls.update();
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Viewer dropdown menu actions
            document.getElementById('fullScreen').addEventListener('click', toggleFullScreen);
            document.getElementById('toggleWireframe').addEventListener('click', toggleWireframe);
            document.getElementById('toggleShadows').addEventListener('click', toggleShadows);
            document.getElementById('resetView').addEventListener('click', resetView);
            document.getElementById('saveViewpoint').addEventListener('click', showSaveViewDialog);
            document.getElementById('viewSavedViews').addEventListener('click', showSavedViewsDialog);
            
            // Element info panel close button
            document.getElementById('closeElementInfo').addEventListener('click', () => {
                document.getElementById('element-info-panel').style.display = 'none';
            });
            
            // Viewer controls
            document.getElementById('zoomIn').addEventListener('click', zoomIn);
            document.getElementById('zoomOut').addEventListener('click', zoomOut);
            document.getElementById('rotateLeft').addEventListener('click', rotateLeft);
            document.getElementById('rotateRight').addEventListener('click', rotateRight);
            document.getElementById('toggleOrbit').addEventListener('click', enableOrbitControls);
            document.getElementById('toggleFirstPerson').addEventListener('click', enableFirstPersonControls);
            
            // Save view confirmation
            document.getElementById('saveViewConfirm').addEventListener('click', saveCurrentView);
        }
        
        // Toggle fullscreen
        function toggleFullScreen() {
            const container = document.getElementById('bim-viewer-container');
            
            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable full-screen mode: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        }
        
        // Toggle wireframe mode
        function toggleWireframe() {
            wireframeMode = !wireframeMode;
            
            if (model) {
                model.traverse((child) => {
                    if (child.isMesh) {
                        child.material.wireframe = wireframeMode;
                    }
                });
            }
        }
        
        // Toggle shadows
        function toggleShadows() {
            shadowsEnabled = !shadowsEnabled;
            renderer.shadowMap.enabled = shadowsEnabled;
            
            scene.traverse((obj) => {
                if (obj.isLight) {
                    obj.castShadow = shadowsEnabled;
                }
                if (obj.isMesh) {
                    obj.castShadow = shadowsEnabled;
                    obj.receiveShadow = shadowsEnabled;
                }
            });
        }
        
        // Reset view
        function resetView() {
            if (model) {
                centerCameraOnModel(model);
            }
        }
        
        // Zoom in
        function zoomIn() {
            camera.position.lerp(controls.target, 0.1);
            controls.update();
        }
        
        // Zoom out
        function zoomOut() {
            camera.position.lerp(controls.target, -0.1);
            controls.update();
        }
        
        // Rotate left
        function rotateLeft() {
            controls.rotateLeft(Math.PI / 12);
            controls.update();
        }
        
        // Rotate right
        function rotateRight() {
            controls.rotateLeft(-Math.PI / 12);
            controls.update();
        }
        
        // Enable orbit controls
        function enableOrbitControls() {
            controls.enableRotate = true;
            controls.enablePan = true;
            controls.enableZoom = true;
            controls.screenSpacePanning = true;
        }
        
        // Enable first person controls
        function enableFirstPersonControls() {
            controls.enableRotate = true;
            controls.enablePan = true;
            controls.enableZoom = true;
            controls.screenSpacePanning = false;
        }
        
        // Show save view dialog
        function showSaveViewDialog() {
            // Capture current viewpoint
            currentViewpoint = {
                position: camera.position.clone(),
                target: controls.target.clone()
            };
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('saveViewModal'));
            modal.show();
        }
        
        // Save current view
        function saveCurrentView() {
            const name = document.getElementById('viewName').value;
            const description = document.getElementById('viewDescription').value;
            
            if (name && currentViewpoint) {
                const viewData = {
                    id: Date.now().toString(),
                    name: name,
                    description: description,
                    position: currentViewpoint.position,
                    target: currentViewpoint.target,
                    date: new Date().toISOString()
                };
                
                // Add to saved views
                savedViews.push(viewData);
                
                // Save to local storage
                localStorage.setItem(
                    `bim_views_${modelData.id}_${modelData.version}`, 
                    JSON.stringify(savedViews)
                );
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('saveViewModal')).hide();
                
                // Reset form
                document.getElementById('saveViewForm').reset();
                
                // Show notification
                showNotification('View saved successfully');
            }
        }
        
        // Show saved views dialog
        function showSavedViewsDialog() {
            // Load saved views from local storage
            const storedViews = localStorage.getItem(`bim_views_${modelData.id}_${modelData.version}`);
            if (storedViews) {
                savedViews = JSON.parse(storedViews);
            }
            
            // Update saved views list
            updateSavedViewsList();
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('savedViewsModal'));
            modal.show();
        }
        
        // Update saved views list
        function updateSavedViewsList() {
            const container = document.getElementById('savedViewsList');
            
            if (savedViews.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No saved views found.</p>';
                return;
            }
            
            // Create cards for each saved view
            let html = '';
            
            savedViews.forEach(view => {
                const date = new Date(view.date).toLocaleDateString();
                
                html += `
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">${view.name}</h5>
                            <p class="card-text small text-muted">Saved on ${date}</p>
                            ${view.description ? `<p class="card-text">${view.description}</p>` : ''}
                            <div class="btn-group w-100">
                                <button class="btn btn-sm btn-primary load-view" data-id="${view.id}">
                                    Load View
                                </button>
                                <button class="btn btn-sm btn-danger delete-view" data-id="${view.id}">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Add event listeners
            document.querySelectorAll('.load-view').forEach(button => {
                button.addEventListener('click', (e) => {
                    const viewId = e.target.dataset.id;
                    loadSavedView(viewId);
                });
            });
            
            document.querySelectorAll('.delete-view').forEach(button => {
                button.addEventListener('click', (e) => {
                    const viewId = e.target.dataset.id;
                    deleteSavedView(viewId);
                });
            });
        }
        
        // Load saved view
        function loadSavedView(viewId) {
            const view = savedViews.find(v => v.id === viewId);
            
            if (view) {
                // Set camera position
                camera.position.set(view.position.x, view.position.y, view.position.z);
                
                // Set controls target
                controls.target.set(view.target.x, view.target.y, view.target.z);
                controls.update();
                
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('savedViewsModal')).hide();
                
                // Show notification
                showNotification(`View "${view.name}" loaded`);
            }
        }
        
        // Delete saved view
        function deleteSavedView(viewId) {
            // Filter out the deleted view
            savedViews = savedViews.filter(v => v.id !== viewId);
            
            // Save to local storage
            localStorage.setItem(
                `bim_views_${modelData.id}_${modelData.version}`, 
                JSON.stringify(savedViews)
            );
            
            // Update saved views list
            updateSavedViewsList();
            
            // Show notification
            showNotification('View deleted');
        }
        
        // Show notification
        function showNotification(message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'alert alert-info notification';
            notification.textContent = message;
            
            // Add to document
            document.body.appendChild(notification);
            
            // Remove after delay
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
    </script>
    
    <style>
        /* Additional styles for notifications */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            padding: 10px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            animation: fadeIn 0.3s ease-out forwards, fadeOut 0.3s ease-in forwards 2.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-20px); }
        }
    </style>
{% endblock %}